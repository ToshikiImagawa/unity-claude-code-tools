# AGENTS.md

このファイルは、Claude Code プラグインのサブエージェント設計・実装に関する原則とベストプラクティスを定義します。

Claude Code (claude.ai/code) がこのリポジトリのプラグインエージェントを開発・レビューする際の指針となります。

---

## プラグインエージェント設計ガイド

このセクションでは、Claude Code プラグインのサブエージェントを設計・実装する際の原則とベストプラクティスを定義します。

### 1. サブエージェントの基本概念

#### 1.1 コンテキストの独立性

サブエージェントは **独立したコンテキストウィンドウ** を使用します。これは以下を意味します：

**重要な特性**:

- サブエージェントは独立したコンテキストウィンドウ (200,000トークン) を使用
- タスク委任時に毎回コンテキスト断裂が発生
- 毎回新しいセッションで起動

**設計の前提**:

```
メインコンテキスト (200,000トークン)
  ↓ 必要十分なコンテキストを渡す
サブエージェント (独立した200,000トークン)
  ↓ 要約結果を返す
メインコンテキスト
```

#### 1.2 トークン効率化の仕組み

サブエージェントを使用することで、メインコンテキストをクリーンに保ちながら、重い処理（レビュー、分析、ログ解析）を隔離できます。

**コンテキスト保護の効果**:

| タスク     | サブエージェント未使用 | サブエージェント使用 | 削減量     |
|:--------|:------------|:-----------|:--------|
| ログ解析    | 15,000トークン  | 500トークン    | -14,500 |
| コードレビュー | 12,000トークン  | 2,500トークン  | -9,500  |
| 設計分析    | 18,000トークン  | 3,500トークン  | -14,500 |

サブエージェントはレビュー・分析の重い処理を隔離し、メインには要約のみを返すことで、メインコンテキストを開発作業に温存します。

### 2. エージェント設計原則

#### 2.1 役割と責務の明確化

各エージェントは **単一の明確な責務** を持つべきです。

**descriptionの書き方**:

```markdown
# Bad: 曖昧

description: "ログをレビューする"

# Good: 明確で具体的

description: "Unity ビルド・テストログを解析し、構造化された結果を返すサブエージェント。Context
消費を最小化するため定型フォーマットで出力します。"
```

**Good descriptionの条件**:

- 何をするか（動詞）
- 何を対象とするか
- どのような観点で処理するか
- 結果としてどうなるか

#### 2.2 入出力インターフェース

すべてのエージェントは明確な入出力インターフェースを定義します。

**標準フォーマット**:

```markdown
## 入力

$ARGUMENTS

### 入力形式

```

対象ファイルパス（必須）: path/to/target/file
オプション: --summary （簡易出力モード）

```

### 入力例

```

my-agent path/to/file.log
my-agent path/to/file.log --summary

```

## 前提条件

**実行前に必要な参照ドキュメントや設定を記載**

## 出力

処理結果のフォーマット定義
```

**入出力設計のポイント**:

- `$ARGUMENTS` で引数を受け取る
- 入力形式を明示（必須/オプション）
- 入力例を複数示す
- 前提条件を明記
- 出力フォーマットを定義

#### 2.3 allowed-toolsの設計方針

`allowed-tools` は **タスクの性質に応じて最小限** に設定します。

**設計パターン**:

| エージェントタイプ  | allowed-tools                           | 理由                         |
|:-----------|:----------------------------------------|:---------------------------|
| **レビュー系**  | Read, Glob, Grep, Edit, AskUserQuestion | コンテキスト効率化のため、Taskツールを使用しない |
| **分析系**    | 全ツール                                    | 柔軟な分析・探索が必要                |
| **フロー管理系** | 全ツール                                    | 全体フローを管理するため、すべてのツールが必要    |
| **ログ解析系**  | Read, Grep                              | 読み込みのみで完結、最小限のツール          |

**重要な制約**: **レビュー系エージェントは Task ツールを使用不可**

理由:

- 大量のファイル読み込みが発生する可能性がある
- Taskツールで再帰的に探索すると、コンテキストが爆発的に増加
- Read, Glob, Grep で必要なファイルを特定し、効率的に読み込む設計

**allowed-tools設計のベストプラクティス**:

```markdown
# Bad: すべてのツールを許可

allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task, AskUserQuestion

# Good: 必要最小限のツールのみ許可

allowed-tools: Read, Glob, Grep, Edit, AskUserQuestion
```

理由: 不要なツールを許可すると、エージェントが非効率な実装を選択する可能性がある。

### 3. 委任すべきタスク vs メインで実行すべきタスク

#### 3.1 基本原則: READ系はサブエージェント、WRITE系は慎重に

**サブエージェントに委任すべきタスク (READ系)**:

| タスク          | 理由                    | 例                 |
|:-------------|:----------------------|:------------------|
| **レビュー・分析**  | コンテキスト汚染を避けたい、結果のみが重要 | コードレビュー、設計レビュー    |
| **ログ解析**     | 大量のログを処理、要約結果のみ必要     | ビルドログ解析、テストログ解析   |
| **複数ソースの探索** | 並列で行いたい検索、独立した視点で評価   | トレーサビリティ確認、依存関係分析 |

**慎重に行うべきタスク (WRITE系)**:

| タスク          | 問題点                      | 対策                     |
|:-------------|:-------------------------|:-----------------------|
| **ドキュメント生成** | 重複したコンテキスト読み込みで無駄なトークン消費 | 基本的にメインエージェント（コマンド）で実行 |
| **コード生成**    | コンテキスト損失が品質に影響           | メインで実行、サブは分析のみ         |

#### 3.2 委譲判断フロー

```
タスクを受け取る
  ↓
READ系タスク? (レビュー、分析、検証、ログ解析)
  ↓ YES
サブエージェントに委任
  ↓ NO
  ↓
WRITE系タスク? (ドキュメント生成、コード生成)
  ↓ YES
メインエージェント（コマンド）で実行

  例外: 自動修正はサブエージェントで許可
```

### 4. エージェント間連携パターン

#### 4.1 コマンド → エージェント呼び出し

**標準パターン**: コマンドが処理を実行した後、自動的にサブエージェントを呼び出します。

```
/my-command
  ↓
1. メイン処理実行
  ↓
2. サブエージェント自動実行
  ├─ ログ解析 or レビュー
  └─ 要約結果出力
  ↓
3. ユーザーに結果を返す
```

#### 4.2 エージェント間データフロー

エージェント間でデータを受け渡す方法:

| 送信元      | 受信先      | 受け渡しデータ | 方法                    |
|:---------|:---------|:--------|:----------------------|
| コマンド     | サブエージェント | ファイルパス  | コマンド引数（`$ARGUMENTS`）  |
| サブエージェント | ファイル     | -       | Read ツールで読み込み         |
| サブエージェント | ファイル     | 修正内容    | Edit ツールで書き込み         |
| サブエージェント | コマンド     | 処理結果    | 要約結果を返す（500〜1000トークン） |

#### 4.3 再委譲の禁止

**重要な制約**: サブエージェントは自分自身または他のサブエージェントに再委譲してはいけません。

**理由**:

- 無限ループ防止
- コンテキスト効率化の意図を損なう
- デバッグの困難性増加

**禁止パターン**:

```markdown
# Bad: サブエージェントが自分自身に再委譲

my-agent
↓
Task tool で my-agent を呼び出す (禁止)
```

```markdown
# Bad: サブエージェントが他のサブエージェントに委譲

agent-a
↓
Task tool で agent-b を呼び出す (禁止)
```

**許可パターン**:

```markdown
# Good: サブエージェントが Read, Glob, Grep で必要な情報を取得

my-agent
├─ Read: 対象ファイル
├─ Grep: パターン検索
└─ 結果を要約して返す
```

**エージェントマニフェストでの制約表明**:

```markdown
allowed-tools: Read, Glob, Grep, Edit, AskUserQuestion

**注意**: このエージェントは Task ツールを使用しません。再委譲を避け、コンテキスト効率化を優先します。
```

### 5. 実践Tips

#### 5.1 descriptionを明確にする

**Good descriptionの要件**:

- 1行で役割を表現
- 対象を明示
- 主要な機能を列挙
- 設計意図を示す

```markdown
# Bad: 曖昧

description: "ファイルをレビューする"

# Good: 明確で具体的

description: "プラグインエージェントの設計をレビューし、AGENTS.md の設計ガイドに基づいて品質チェックを行います。"
```

#### 5.2 allowed-toolsを最小限にする

**設計ルール**:

1. タスクの性質を分析（READ系 or WRITE系）
2. 必要最小限のツールを選択
3. 特にTaskツールは慎重に判断（コンテキスト効率化）

```markdown
# Bad: すべてのツールを許可

allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task, AskUserQuestion

# Good: レビュー系エージェント（READ系）

allowed-tools: Read, Glob, Grep, Edit, AskUserQuestion
```

#### 5.3 大きなコンテキストはファイルで委任

**問題**: プロンプトに全データを貼り付けるとトークンエラー

**解決策**: ファイルパスで委任

```markdown
# Bad: プロンプトに全ログを貼り付け

prompt: "[10,000行のログ内容]を解析してください"

# Good: ファイルパスで委任

prompt: "対象ログファイル: /tmp/build-12345.log"
```

**メリット**:

- コンテキスト汚染防止
- トークン制限エラー回避
- サブエージェントが必要な情報のみ読み取り

#### 5.4 出力フォーマットを固定する

サブエージェントの出力は **定型フォーマット** にすることで、メインエージェントが結果を解析しやすくなります。

**例: ログ解析エージェントの出力**:

```
[BUILD OK] エラーなし
```

```
[BUILD FAILED] 3件のエラー
- Assets/Scripts/Foo.cs(10): CS0246 型が見つかりません
- Assets/Scripts/Bar.cs(25): CS1061 メンバーが存在しません
```

**メリット**:

- メインエージェントが結果を即座に理解
- 後続処理の自動化が容易
- Context 消費の最小化
